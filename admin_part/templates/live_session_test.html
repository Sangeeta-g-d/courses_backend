{# live_session_test.html #}
{% extends 'admin_base.html' %}
{% block content %}
<div class="container py-5">
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="fw-bold mb-0">Live Sessions</h2>
    <a href="{% url 'add_live_session' %}" class="btn btn-primary">
      <i class="bi bi-plus-circle"></i> Create New Session
    </a>
  </div>

  <div class="row g-4">
    {% for session in sessions %}
    <div class="col-md-6 col-lg-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-header bg-light">
          <h6 class="mb-0 text-truncate">{{ session.title }}</h6>
        </div>
        <div class="card-body">
          <p class="text-muted small mb-2">{{ session.agenda|truncatewords:20 }}</p>
          <div class="session-info small mb-3">
            <div class="mb-1">
              <i class="bi bi-calendar-event text-primary"></i>
              {{ session.session_date }} at {{ session.session_time }}
            </div>
          </div>

          {% if session.is_active %}
          <button class="btn btn-success w-100 join-session mb-2"
                  data-session-id="{{ session.id }}"
                  data-meeting-url="{{ session.meeting_url }}">
            <i class="bi bi-camera-video"></i> Join Session
          </button>
          {% else %}
          <button class="btn btn-secondary w-100 mb-2" disabled>
            <i class="bi bi-hourglass-split"></i> Not Yet Started
          </button>
          {% endif %}
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Modal or container for Zoom -->
<div id="zoomModal" class="modal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered" style="max-width:1200px;">
    <div class="modal-content" style="height: 80vh;">
      <div class="modal-header">
        <h5 class="modal-title">Live Session</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close" id="closeZoomModal"></button>
      </div>
      <div class="modal-body p-0" style="height: calc(80vh - 56px);">
        <!-- Zoom app will mount here -->
        <div id="zoom-root" style="width: 100%; height: 100%;"></div>
      </div>
    </div>
  </div>
</div>

<!-- Include Zoom Meeting SDK (CDN) -->
<!-- NOTE: confirm version from Zoom docs and update as necessary -->
<script src="https://source.zoom.us/2.14.0/zoom-meeting-embedded-2.14.0.min.js"></script>

<script>
document.querySelectorAll('.join-session').forEach(btn => {
  btn.addEventListener('click', async function () {
    const sessionId = this.getAttribute('data-session-id');
    const meetingUrl = this.getAttribute('data-meeting-url');

    // Extract meetingNumber from meetingUrl client-side (fallback)
    function extractMeetingNumber(url) {
      const re = /\/j\/(\d+)|\/s\/(\d+)/;
      const m = url.match(re);
      if (!m) {
        const fallback = url.match(/(\d{9,12})/);
        return fallback ? fallback[1] : null;
      }
      return m[1] || m[2];
    }

    const meetingNumber = extractMeetingNumber(meetingUrl);
    if (!meetingNumber) {
      alert('Cannot extract meeting id from stored meeting URL. Please provide meeting id in the session record.');
      return;
    }

    // Ask backend for a short-lived signature
    const role = 0; // participant (0) or host (1). If admin is host, set 1.
    const sigResp = await fetch(`/zoom/get_signature/?session_id=${sessionId}&role=${role}`);
    if (!sigResp.ok) {
      const txt = await sigResp.text();
      alert('Unable to get signature: ' + txt);
      return;
    }
    const data = await sigResp.json();
    const signature = data.signature;
    if (!signature) {
      alert('Invalid signature returned from server.');
      return;
    }

    // configure the SDK client
    // ZoomMtgEmbedded is provided by the SDK script
    const client = ZoomMtgEmbedded.createClient();

    // mount point
    const zoomRoot = document.getElementById('zoom-root');
    zoomRoot.innerHTML = ''; // clear previous

    // Initialize client
    client.init({
      debug: false,
      zoomAppRoot: zoomRoot,
      language: 'en-US'
      // You can add additional config: customize UI, show/hide controls etc.
    });

    // Determine meeting password (if any) — this example does not use password
    const meetingPassword = ''; // if you have password saved, pass here

    // join the meeting
    client.join({
      sdkKey: "{{ ZOOM_SDK_KEY|default:'' }}", // optional to fill server-side if you render it. Alternatively fetch from server if needed.
      signature: signature,
      meetingNumber: meetingNumber.toString(),
      password: meetingPassword,
      userName: "Vidya",
      // optional: userEmail, tk (ticket) if required
    });

    // Show modal
    var zoomModal = new bootstrap.Modal(document.getElementById('zoomModal'));
    zoomModal.show();

    // Close handling — destroy the client instance to cleanup
    document.getElementById('closeZoomModal').addEventListener('click', function () {
      try {
        client.leave();
      } catch (e) { /* ignore */ }
      zoomRoot.innerHTML = '';
    }, { once: true });
  });
});
</script>
{% endblock %}
